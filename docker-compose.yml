services:
  code:
    image: rust
    stdin_open: true
    tty: true
    working_dir: /code
    command: bash
    volumes:
      - .:/code:cached
      - target:/cargo-target
      - cargo:/usr/local/cargo
      - ~/.ssh:/root/.ssh
    ports:
      - "9080:9080"
  redis:
    image: redis:6.2.6
    command: redis-server
    ports:
      - 6379:6379
  zookeeper:
    image: apachepulsar/pulsar:latest
    restart: on-failure
    environment:
      - metadataStoreUrl=zk:zookeeper:2181
      - PULSAR_MEM=-Xms256m -Xmx256m -XX:MaxDirectMemorySize=256m
    command: |
      bash -c "bin/apply-config-from-env.py conf/zookeeper.conf && \
             bin/generate-zookeeper-config.sh conf/zookeeper.conf && \
             exec bin/pulsar zookeeper"
    healthcheck:
      test: ["CMD", "bin/pulsar-zookeeper-ruok.sh"]
      interval: 10s
      timeout: 5s
      retries: 30
  pulsar-init:
    image: apachepulsar/pulsar:latest
    entrypoint: ["/bin/bash", "/script/init_cluster"]
    volumes:
      - ./script:/script
    depends_on:
      zookeeper:
        condition: service_healthy
  bookie-1:
    image: apachepulsar/pulsar:latest
    restart: on-failure
    environment:
      - clusterName=cluster-a
      - zkServers=zookeeper:2181
      - metadataServiceUri=metadata-store:zk:zookeeper:2181
      # otherwise every time we run docker compose up or down we fail to start due to Cookie
      # See: https://github.com/apache/bookkeeper/blob/405e72acf42bb1104296447ea8840d805094c787/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java#L57-68
      - advertisedAddress=bookie-1
      - BOOKIE_MEM=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m
    depends_on:
      zookeeper:
        condition: service_healthy
      pulsar-init:
        condition: service_completed_successfully
    command: bash -c "bin/apply-config-from-env.py conf/bookkeeper.conf && exec bin/pulsar bookie"
  bookie-2:
    image: apachepulsar/pulsar:latest
    restart: on-failure
    environment:
      - clusterName=cluster-a
      - zkServers=zookeeper:2181
      - metadataServiceUri=metadata-store:zk:zookeeper:2181
      # otherwise every time we run docker compose up or down we fail to start due to Cookie
      # See: https://github.com/apache/bookkeeper/blob/405e72acf42bb1104296447ea8840d805094c787/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java#L57-68
      - advertisedAddress=bookie-2
      - BOOKIE_MEM=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m
    depends_on:
      zookeeper:
        condition: service_healthy
      pulsar-init:
        condition: service_completed_successfully
    command: bash -c "bin/apply-config-from-env.py conf/bookkeeper.conf && exec bin/pulsar bookie"
  bookie-3:
    image: apachepulsar/pulsar:latest
    restart: on-failure
    environment:
      - clusterName=cluster-a
      - zkServers=zookeeper:2181
      - metadataServiceUri=metadata-store:zk:zookeeper:2181
      # otherwise every time we run docker compose up or down we fail to start due to Cookie
      # See: https://github.com/apache/bookkeeper/blob/405e72acf42bb1104296447ea8840d805094c787/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java#L57-68
      - advertisedAddress=bookie-3
      - BOOKIE_MEM=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m
    depends_on:
      zookeeper:
        condition: service_healthy
      pulsar-init:
        condition: service_completed_successfully
    command: bash -c "bin/apply-config-from-env.py conf/bookkeeper.conf && exec bin/pulsar bookie"

  broker-1:
    image: apachepulsar/pulsar:latest
    hostname: broker
    restart: on-failure
    environment:
      - metadataStoreUrl=zk:zookeeper:2181
      - zookeeperServers=zookeeper:2181
      - clusterName=cluster-a
      - advertisedAddress=broker-1
      - advertisedListeners=external:pulsar://broker-1:6650
      - brokerDeleteInactiveTopicsEnabled=false
      - PULSAR_MEM=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m
      - managedLedgerDefaultEnsembleSize=2
      - managedLedgerDefaultWriteQuorum=2
      - managedLedgerDefaultAckQuorum=2
    depends_on:
      zookeeper:
        condition: service_healthy
      bookie-1:
        condition: service_started
      bookie-2:
        condition: service_started
    ports:
      - "6650:6650"
      - "8080:8080"
    command: bash -c "bin/apply-config-from-env.py conf/broker.conf && exec bin/pulsar broker"

  broker-2:
    image: apachepulsar/pulsar:latest
    hostname: broker
    restart: on-failure
    environment:
      - metadataStoreUrl=zk:zookeeper:2181
      - zookeeperServers=zookeeper:2181
      - clusterName=cluster-a
      - advertisedAddress=broker-2
      - advertisedListeners=external:pulsar://broker-2:6650
      - brokerDeleteInactiveTopicsEnabled=false
      - PULSAR_MEM=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m
      - managedLedgerDefaultEnsembleSize=2
      - managedLedgerDefaultWriteQuorum=2
      - managedLedgerDefaultAckQuorum=2
    depends_on:
      zookeeper:
        condition: service_healthy
      bookie-1:
        condition: service_started
      bookie-2:
        condition: service_started
    ports:
      - "6651:6650"
      - "8081:8080"
    command: bash -c "bin/apply-config-from-env.py conf/broker.conf && exec bin/pulsar broker"

  broker-3:
    image: apachepulsar/pulsar:latest
    hostname: broker
    restart: on-failure
    environment:
      - metadataStoreUrl=zk:zookeeper:2181
      - zookeeperServers=zookeeper:2181
      - clusterName=cluster-a
      - advertisedAddress=broker-3
      - advertisedListeners=external:pulsar://broker-3:6650
      - brokerDeleteInactiveTopicsEnabled=false
      - PULSAR_MEM=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m
      - managedLedgerDefaultEnsembleSize=2
      - managedLedgerDefaultWriteQuorum=2
      - managedLedgerDefaultAckQuorum=2
    depends_on:
      zookeeper:
        condition: service_healthy
      bookie-1:
        condition: service_started
      bookie-2:
        condition: service_started
    ports:
      - "6652:6650"
      - "8082:8080"
    command: bash -c "bin/apply-config-from-env.py conf/broker.conf && exec bin/pulsar broker"


volumes:
  target:
  cargo:
